<!DOCTYPE html>
<html>
<head>
<style type="text/css">
.skill {
	border: 1px solid black;
	padding: 2px;
	position: relative;
	display: inline-block;
	cursor: pointer;
}

.skill:hover {
	background: orange;
}

#log {
	position: absolute;
	border: 1px solid black;
	position: absolute;
	width: 200px;
	height: calc(100% - 2px);
	top: 0px;
	left: calc(50% - 111px);
	padding: 0px 10px;
}

#canvas {
	position: absolute;
	top: 0px;
	left: 0px;
	width: calc(100%);
	height: calc(100%);
}

body {
	font-family: calibri;
	font-size: 12px;
}
</style>
<script type="text/javascript">

let canvas;
let context;
window.onload = init;

function init() {
	canvas = document.getElementById('canvas');
	context = canvas.getContext('2d');
	window.requestAnimationFrame(gameLoop);
}

let secondsPassed = 0;
let oldTimeStamp = 0;


function gameLoop(timeStamp) {
	secondsPassed = (timeStamp - oldTimeStamp) / 1000;
	oldTimeStamp = secondsPassed;
	secondsPassed = Math.min(secondsPassed, 0.1);

	draw();
	window.requestAnimationFrame(gameLoop);
}

let pixelCount = 200;
let startValue = [255, 255, 255];

function draw() {
	//clearCanvas
	context.clearRect(0, 0, canvas.width, canvas.height);

	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight;

	let pixelSize = Math.ceil(canvas.width / pixelCount);
	let heightCount = Math.ceil(canvas.height / pixelSize) + 1;
	let loopCount = pixelCount * heightCount;
	let worldCursor = [0, 0];

	let colors = [startValue[0], startValue[1], startValue[2]];
	let cChange = [-10, -10, -10];

	for (let foo = 0; foo < loopCount; foo++) {
		context.fillStyle = 'rgb('+colors[0]+', '+colors[1]+', '+colors[2]+')';
		context.fillRect(worldCursor[0] * pixelSize, worldCursor[1] * pixelSize, pixelSize, pixelSize);
		worldCursor[0]++;
		if (worldCursor[0] > pixelCount) {
			worldCursor[0] = 0;
			worldCursor[1]++;
		}

		colors[0] = colors[0] + cChange[0];
		colors[1] = colors[1] + cChange[1];
		colors[2] = colors[2] + cChange[2];

		cChange = [randomChange(), randomChange(), randomChange()];
	}
	
	startValue[0] = startValue[0] + cChange[0];
	startValue[1] = startValue[1] + cChange[1];
	startValue[2] = startValue[2] + cChange[2];
}

function randomChange() {
	return (10 * (Math.floor(Math.random() * 3) - 1));
}

moveList = [
	{
		'name':'attack',
		'stateUsable':[0],
		'stateResolve':3,
		'text':['attack']
	},
	{
		'name':'block',
		'stateUsable':[1],
		'stateResolve':0,
		'text':['block']
	},
	{
		'name':'dodge',
		'stateUsable':[1],
		'stateResolve':0,
		'text':['dodge']
	},
	{
		'name':'pass',
		'stateUsable':[0, 1],
		'stateResolve':2,
		'text':['pass']
	},
];
combatState = 0 //0 = player initiating, 1 = player reacting, 2 = enemy initiating, 3 = enemy reacting
	
function main(val, move) {
	if (move != null) {
		getMoveData = 0;
		for (i = 0; i < moveList.length; i++) {
			if (moveList[i].name == move) {
				getMoveData = i;
				break;
			}
		}
		if (combatState < 2) {
			addLogText('You '+moveList[getMoveData].text+'.');
		} else if (combatState > 1) {
			addLogText('The Enemy '+moveList[getMoveData].text+'s.');
		}
	}
	combatState = val;
	updateSkills();
	if (combatState > 1) {
		enemyReacts();
	}
}

function updateSkills() {
	document.getElementById('playerSkills').innerHTML = '';
	if (combatState < 2) {
		for (i = 0; i < moveList.length; i++) {
			if (moveList[i].stateUsable.indexOf(combatState) != -1) {
				generateMove(moveList[i].stateResolve, moveList[i].name);
			}
		}
	}
}

function updateCombatState(val) {
	combatState = val;
}

function generateMove(nextState, moveName) {
	document.getElementById('playerSkills').innerHTML += '<div class=skill onclick="main('+nextState+', \''+moveName+'\')">'+moveName+'</div>';
}

function addLogText(entry) {
	let strLog = document.getElementById('log').innerHTML;
	document.getElementById('log').innerHTML = entry + "<br>" + strLog;
}

function enemyReacts() {
	if (combatState == 2) {
		setTimeout(function() {
			main(1, 'attack');
		}, 1000);
	} else if (combatState == 3) {
		setTimeout(function() {
			main(2, 'dodge');
		}, 1000);
	}
}

</script>
</head>
<body>
<canvas id="canvas"></canvas>
<div id=playerSkills>
	
</div>
<div id=log>You think you can beat me punk? Give it your best shot.</div>
</body>

<script type="text/javascript">
	
main(0, null);

</script>

</html>
